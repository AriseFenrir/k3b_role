#SPDX-License-Identifier: MIT-0
---

    - name: Installer docker
      ansible.builtin.shell: curl -fsSL https://get.docker.com | sh
      become: true
      args:
        creates: /usr/bin/docker

    - name: Installer kubectl
      ansible.builtin.shell: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        install -m 0755 kubectl /usr/local/bin/kubectl
      become: true
      args:
        creates: /usr/local/bin/kubectl

    - name: Installer k3d
      ansible.builtin.shell: "curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash"
      become: true
      args:
        creates: /usr/local/bin/k3d

    - name: Creer le cluster k3d-lab
      ansible.builtin.command: k3d cluster create k3d-lab --servers 1 --agents 1 -p "30080:30080@agent:0"
      become: true
      register: k3d_result
      failed_when:
        - k3d_result.rc != 0
        - "'already exists' not in k3d_result.stderr"
      changed_when: "'created' in k3d_result.stdout"

    - name: Creer le manifest nginx.yaml
      ansible.builtin.copy:
        dest: "./nginx.yaml"
        content: |
          apiVersion: v1
          kind: Pod
          metadata:
            name: nginx
            labels:
              app: nginx
          spec:
            containers:
            - name: nginx
              image: nginx:latest
              ports:
              - containerPort: 80
              lifecycle:
                postStart:
                  exec:
                    command: ["/bin/sh", "-c", "echo '<h1>Bienvenue dans le k3d LAB</h1>' > /usr/share/nginx/html/index.html"]
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: nginx-service
          spec:
            type: NodePort
            selector:
              app: nginx
            ports:
            - port: 80
              targetPort: 80
              nodePort: 30080

    - name: Appliquer le manifest avec kubectl apply
      ansible.builtin.shell: |
        export KUBECONFIG=$(k3d kubeconfig write k3d-lab)
        kubectl apply -f ./nginx.yaml --validate=false
      become: true

    - name: Afficher l'URL d'accès au service
      ansible.builtin.debug:
        msg: "URL d'accès : http://localhost:30080"
